# Ch57 封锁粒度
封锁对象的大小称为封锁粒度

封锁对象
- 逻辑单元
  - 属性值
  - 属性值的集合
  - 元组
  - 关系
  - 索引项
  - 整个索引
  - 整个数据库
- 物理单元
  - 页
  - 物理记录等

## 选择封锁粒度的原则
封锁粒度与系统的并发度和并发控制的开销密切相关
- 粒度越大, 数据库所能封锁的数据单元就越少, 并发度就月小, 系统开销也越小

### 多粒度封锁
在一个系统中同时支持多种封锁粒度, 供不同的事务选择

同时考虑封锁开销和并发度两个因素, 选择合适的封锁粒度
- 需要处理多个关系的大量元组的用户事务: 以数据库为封锁单位
- 需要处理大量元组的用户事务: 以关系为封锁单位
- 只处理少量元组的用户事务: 以元组为封锁单位

多粒度树
- 以树形结构来表示多级封锁粒度
- 根节点是整个数据库
- 叶节点表示最小的数据粒度

### 多粒度封锁协议
运行多粒度树中的每个节点被独立地加锁

对一个节点加锁, 意味着这个节点的所有下层节点也被加以同样类型的锁

在多粒度封锁中一个数据对象可能以两种方式封锁
- 显式封锁: 直接加到数据对象上
- 隐式封锁: 加到上级节点的锁

系统检查封锁冲突时既要检查显式封锁也要检查隐式封锁
- 该数据对象有无显式封锁与之冲突
- 所有上级节点的隐式封锁有无冲突
- 所有下级节点的显示封锁有无冲突

引进意向锁, 目的是提高对某个数据对象加锁时系统的检查效率
- 如果对一个节点加意向锁, 说明该节点的下层节点正在被加锁
- 对任一节点加基本锁时, 必须先对上层节点加意向锁

意向共享锁, 简称IS锁, 表示下层节点意向加S锁

意向排它锁, 简称IX锁, 表示下层节点意向加X锁

共享意向排它锁, 简称SIX锁, 表示对它加S锁, 再加IX锁
*对某个表加SIX锁, 表示该事务要读整个表, 同时会更新表内的个别元组*


锁的强度: 是指它对其他锁的排斥程度

一个事务在申请封锁时以强锁代替弱锁是安全的, 反之则不然
![alt text](/assets/ch57image0.png)


具有意向锁的多粒度封锁方法
- 申请锁时应该按自上而下的次序进行
- 释放封锁时应该按自下而上的次序进行

*例如, $T_1$要对关系$R_1$加S锁, 要首先对数据库加IS锁, 检查数据库和$R_1$是否已经加了不相容的锁, 不再需需要搜索和检查$R_1$中的元组是否加了不相容的锁*