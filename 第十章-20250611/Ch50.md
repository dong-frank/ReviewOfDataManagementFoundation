# Ch50 数据转储和日志文件

## 数据转储
转储是指数据库管理员定期地将整个数据库复制到磁带, 磁盘或其他存储介质上保存起来的过程

备用的数据文本称为后备副本或后援副本

数据库遭到破坏后可以将后备副本重新装入

只能恢复到转储时的状态

要重新运行转储后到故障发生的所有更新事务

### 转储方法
静态转储
- 在系统中无运行事务时进行的转储操作
- 转储开始时数据库处于一致性状态
- 优点是实现简单
- 缺点是降低了数据库的可用性, 转储必须等待正在运行的事务结束, 新的事务必须等转储结束

动态转储
- 转储操作与用户事务并发执行
- 转储期间运行对数据库进行存取和修改
- 缺点是不能保证副本中的数据正确有效

所以需要一个日志文件, 用来登记动态转储期间各事务对数据库的修改活动, 后备副本加上日志文件就能把数据库恢复到某一时刻的正确状态


### 海量转储与增量转储
海里转储: 每次转储全部数据库

增量转储: 只转储上次转储更新过的数据


## 日志文件
是用来记录事务对数据库的更新操作的文件

日志文件的格式
- 以记录为单位
- 以数据块为单位

以记录为单位的日志文件
- 一个日志记录包含
  - 各个事务的开始标记
  - 各个事务的结束标记
  - 各个事务的所有更新操作

以数据块为单位的日志文件
- 一个日志记录包括
  - 事务标识
  - 被更新的数据块


具体作用
- 事务故障恢复和系统故障恢复必须用日志文件
- 动态转储中必须建立日志文件


### 登记日志文件
为保证数据库是可恢复的, 必须遵循两条原则
- 登记的次序严格按并发事务执行的时间次序
- 必须先写日志文件, 后写数据库

为什么要先写日志文件
- 写数据库和写日志文件是两个不同的操作
- 在这两个操作之间可能发生故障
- 如果先写了数据库, 而在日志文件中没有登记下这个修改, 则以后就无法恢复这个修改了
- 如果先写日志, 但没有修改数据库, 按日志文件恢复时只不过多执行一次不必要的UNDO, 并不会影响数据库的正确性